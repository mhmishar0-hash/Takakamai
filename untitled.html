<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TAKA KAMAI</title>

  <script src='//libtl.com/sdk.js' data-zone='10596279' data-sdk='show_10596279'></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Global Styles & Theme */
    body { 
        font-family: 'Inter', sans-serif; 
        background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.95)), url('https://images.unsplash.com/photo-1548586196-aa5803b77379?q=80&w=1000&auto=format&fit=crop');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        color: #ffffff; 
    }

    /* Custom Glassmorphism */
    .card-bg { 
        background-color: rgba(20, 20, 20, 0.85); 
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .border-accent { border-color: #f43f5e; } /* Rose Red */
    .text-accent { color: #f43f5e; }
    
    /* Buttons */
    .btn, .btn-accent { transition: all 0.2s ease-in-out; transform: scale(1); }
    .btn:active, .btn-accent:active { transform: scale(0.96); }
    
    .btn-accent { background-color: #f43f5e; color: #ffffff; font-weight: bold; }
    .btn-accent:hover { background-color: #be123c; }
    
    .input-field { background-color: rgba(44, 44, 44, 0.9); border: 1px solid #555; color: white; outline: none; }
    .input-field:focus { border-color: #f43f5e; }
    
    /* Page Transitions */
    .main-page { display: none; }
    .main-page.active { display: flex; animation: fadeIn 0.5s ease-in-out; }
    .sub-page { display: none; }
    .sub-page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
    
    /* Navigation */
    .bottom-nav a.active { color: #f43f5e; }
    .bottom-nav a.active i { transform: translateY(-2px); transition: transform 0.2s; }
    
    /* Loaders & Notifications */
    #loader { background-color: #121212; }
    .notification-dot {
      position: absolute; top: 0; right: 0; width: 8px; height: 8px;
      background-color: #ef4444; border-radius: 50%; display: none;
    }
    .ip-warning { background-color: #dc2626; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; display: none; font-size: 0.85rem; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Scrollbar for Referral List */
    .scrollbar-thin::-webkit-scrollbar { width: 4px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
  </style>
</head>

<body class="max-w-md mx-auto min-h-screen relative overflow-hidden">

  <div id="loader" class="hidden fixed inset-0 bg-opacity-90 flex flex-col items-center justify-center z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent mb-4"></div>
    <p class="text-xs text-gray-400">Loading Taka Kamai...</p>
  </div>

  <div id="ip-warning" class="ip-warning fixed top-4 left-4 right-4 z-50 mx-auto max-w-sm shadow-lg">
    ⚠️ Warning: Multiple device detected! You can only use one device per account.
  </div>

  <div id="timer-modal" class="hidden fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-[60] p-6">
    <div class="bg-gray-800 rounded-xl p-8 w-full max-w-xs text-center border border-accent relative">
      <div class="absolute -top-10 left-0 right-0 flex justify-center">
        <div class="bg-accent rounded-full p-3 shadow-lg animate-bounce">
            <i data-lucide="clock" class="text-white w-6 h-6"></i>
        </div>
      </div>
      <h3 class="text-xl font-bold mb-4 text-white mt-4">Please Wait</h3>
      <div class="text-5xl font-mono font-bold mb-6 text-accent" id="countdown-display">0</div>
      <p class="text-gray-400 text-xs">কাজটি সম্পন্ন না হওয়া পর্যন্ত অপেক্ষা করুন।</p>
    </div>
  </div>

  <div id="auth-section" class="min-h-screen p-6 flex-col justify-center main-page items-center">
    <div class="card-bg p-8 rounded-2xl shadow-2xl border-t-4 border-accent w-full max-w-sm">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-accent rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <span class="text-3xl">৳</span>
            </div>
            <h1 class="text-3xl font-bold text-accent">TAKA KAMAI</h1>
            <p class="text-gray-400 text-sm mt-1">Start earning today</p>
        </div>

        <div id="auth-container">
            <div id="login-view">
                <div class="space-y-4">
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                        <input id="login-email" type="email" placeholder="Email Address" class="w-full pl-10 p-3 rounded-lg input-field">
                    </div>
                    <div class="relative">
                        <i data-lucide="lock" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                        <input id="login-password" type="password" placeholder="Password" class="w-full pl-10 p-3 rounded-lg input-field">
                    </div>
                </div>
                <button id="login-btn" class="w-full mt-6 p-3 rounded-lg btn-accent shadow-lg font-bold">LOGIN</button>
                <p class="text-center text-gray-400 text-sm mt-6">Don't have an account?
                    <a href="#" id="show-signup" class="font-bold text-accent hover:underline">Sign Up</a>
                </p>
            </div>

            <div id="signup-view" class="hidden">
                <div class="space-y-4">
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                        <input id="signup-name" type="text" placeholder="Full Name" class="w-full pl-10 p-3 rounded-lg input-field">
                    </div>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                        <input id="signup-email" type="email" placeholder="Email Address" class="w-full pl-10 p-3 rounded-lg input-field">
                    </div>
                    <div class="relative">
                        <i data-lucide="lock" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                        <input id="signup-password" type="password" placeholder="Password (Min 6 chars)" class="w-full pl-10 p-3 rounded-lg input-field">
                    </div>
                </div>
                <button id="signup-btn" class="w-full mt-6 p-3 rounded-lg btn-accent shadow-lg font-bold">CREATE ACCOUNT</button>
                <p class="text-center text-gray-400 text-sm mt-6">Already have an account?
                    <a href="#" id="show-login" class="font-bold text-accent hover:underline">Login</a>
                </p>
            </div>
        </div>
    </div>
  </div>

  <div id="app-container" class="min-h-screen flex-col main-page relative">
    
    <header class="flex items-center justify-between p-4 sticky top-0 bg-black bg-opacity-80 backdrop-blur-md z-40 border-b border-gray-800">
      <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center text-white font-bold">৳</div>
          <h1 class="text-lg font-bold text-white tracking-wide">TAKA KAMAI</h1>
      </div>
      <div class="flex items-center space-x-4">
        <div id="notification-bell" class="relative cursor-pointer hover:text-accent transition">
          <i data-lucide="bell" class="w-6 h-6"></i>
          <div id="notification-dot" class="notification-dot"></div>
        </div>
        <div class="cursor-pointer hover:text-accent transition" onclick="navigateTo('profile-page')">
            <i data-lucide="settings" class="w-6 h-6"></i>
        </div>
      </div>
    </header>

    <main class="flex-grow pb-24 overflow-y-auto"> 
      
      <div id="home-page" class="p-4 space-y-6 sub-page">
        <div class="card-bg p-6 rounded-2xl border-l-4 border-accent shadow-xl relative overflow-hidden">
          <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
              <i data-lucide="coins" class="w-32 h-32"></i>
          </div>
          <div class="relative z-10">
            <p class="text-gray-400 text-sm font-medium">Current Balance</p>
            <div class="flex items-baseline mt-1">
                <span class="text-4xl font-bold text-white mr-2" id="coin-balance">0</span>
                <span class="text-accent font-bold">Coins</span>
            </div>
            <button onclick="navigateTo('wallet-page')" class="mt-4 bg-white text-black font-bold px-6 py-2 rounded-full text-sm hover:bg-gray-200 transition shadow-md flex items-center gap-2">
                Withdraw <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
          </div>
        </div>

        <div class="card-bg p-1 rounded-xl shadow-lg border border-gray-700">
           <div class="bg-gradient-to-r from-gray-900 to-black rounded-lg p-4 text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/2454/2454269.png" alt="Money" class="h-24 w-auto mx-auto mb-3 drop-shadow-lg animate-pulse">
                <h2 class="text-lg font-bold text-white mb-2">Daily Earning Hub</h2>
                <p class="text-gray-400 text-xs mb-4 px-2">
                    প্রতিদিন অ্যাপ ভিজিট করুন এবং টাস্ক কমপ্লিট করে আয় করুন।
                </p>
                <button onclick="navigateTo('earn-page')" class="w-full p-3 rounded-lg btn-accent font-bold shadow-lg">Start Earning</button>
           </div>
        </div>
      </div>

      <div id="earn-page" class="p-4 space-y-5 sub-page">
        <div class="flex justify-between items-center bg-gray-800 bg-opacity-60 p-4 rounded-xl border border-gray-700">
            <div>
              <h2 class="text-lg font-bold text-white">Daily Tasks</h2>
              <p class="text-xs text-gray-400">Reset at 12:00 AM</p>
            </div>
            <div class="text-right">
              <p class="text-[10px] text-gray-400 uppercase tracking-wider">Remaining</p>
              <span id="ads-left-count" class="font-bold text-xl text-accent">...</span>
            </div>
        </div>

        <div class="space-y-4">
            <div class="bg-gradient-to-r from-orange-600 to-orange-500 p-4 rounded-xl flex items-center justify-between shadow-lg text-white">
              <div class="flex items-center space-x-3">
                <div class="bg-white bg-opacity-20 p-2 rounded-full">
                    <i data-lucide="play-circle" class="w-6 h-6"></i>
                </div>
                <div>
                  <h3 class="font-bold text-md">Watch Video Ad</h3>
                  <p class="text-xs opacity-90">+50 Coins per view</p>
                </div>
              </div>
              <button class="bg-black bg-opacity-30 hover:bg-opacity-50 text-white font-bold px-4 py-2 rounded-lg text-xs transition border border-white border-opacity-20" onclick="claimReward('interstitial')">START</button>
            </div>

            <div class="card-bg p-4 rounded-xl flex items-center justify-between border border-gray-700">
              <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-2 rounded-full">
                    <i data-lucide="globe" class="w-6 h-6"></i>
                </div>
                <div>
                  <h3 class="font-bold text-md text-white">Visit Website</h3>
                  <p class="text-xs text-gray-400">Stay 20 seconds</p>
                </div>
              </div>
              <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg text-xs transition" onclick="visitWebsite('https://iqxltd.blogspot.com', 20)">VISIT</button>
            </div>
            
            <div class="card-bg p-4 rounded-xl flex items-center justify-between border border-gray-700 opacity-50 cursor-not-allowed">
                <div class="flex items-center space-x-3">
                  <div class="bg-gray-700 p-2 rounded-full">
                      <i data-lucide="lock" class="w-6 h-6 text-gray-400"></i>
                  </div>
                  <div>
                    <h3 class="font-bold text-md text-gray-300">Premium Task</h3>
                    <p class="text-xs text-gray-500">Coming Soon</p>
                  </div>
                </div>
              </div>
        </div>
      </div>

      <div id="wallet-page" class="p-4 space-y-6 sub-page">
        <h2 class="text-xl font-bold text-center text-white">Wallet & Withdraw</h2>
        
        <div class="card-bg p-6 rounded-xl shadow-lg border border-gray-700">
          <div class="text-center mb-6">
              <p class="text-sm text-gray-400 mb-1">Available to Withdraw</p>
              <p class="text-4xl font-bold text-white"><span id="wallet-coin-balance">0</span> <span class="text-accent text-lg">Coins</span></p>
          </div>
          
          <div class="space-y-3">
              <input id="withdraw-amount" type="number" placeholder="Amount (Coins)" class="w-full p-3 rounded-lg input-field">
              
              <div class="grid grid-cols-3 gap-2">
                  <button class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-xs text-white" onclick="document.getElementById('withdraw-amount').value=5000">5k</button>
                  <button class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-xs text-white" onclick="document.getElementById('withdraw-amount').value=10000">10k</button>
                  <button class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-xs text-white" onclick="document.getElementById('withdraw-amount').value=20000">20k</button>
              </div>

              <select id="withdraw-method" class="w-full p-3 rounded-lg input-field bg-gray-800">
                <option value="Bkash">Bkash</option>
                <option value="Nagad">Nagad</option>
                <option value="Rocket">Rocket</option>
              </select>
              <input id="payment-number" type="number" placeholder="Mobile Number" class="w-full p-3 rounded-lg input-field">
          </div>
          
          <button id="withdraw-btn" class="w-full mt-4 p-3 rounded-lg btn-accent shadow-md font-bold">REQUEST PAYMENT</button>
          
          <p class="text-[10px] text-gray-500 mt-4 text-center border-t border-gray-700 pt-2" id="min-withdrawal-info">Minimum withdrawal: 5000 Coins. Payment within 24 hours.</p>
        </div>

        <div class="mt-4">
          <h3 class="font-bold text-white mb-3 text-sm flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> Recent Transactions</h3>
          <div id="withdrawal-history-list" class="space-y-2">
              <p class="text-center text-gray-500 text-xs">No history found.</p>
          </div>
        </div>
      </div>

      <div id="refer-page" class="p-4 space-y-6 sub-page">
        <h2 class="text-xl font-bold text-center text-white">Invite Friends</h2>
        <div class="card-bg p-6 rounded-xl shadow-lg border border-accent relative overflow-hidden">
          
          <div class="text-center relative z-10">
              <div class="bg-accent bg-opacity-20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                 <i data-lucide="gift" class="w-8 h-8 text-accent"></i>
              </div>
              <h3 class="text-lg font-bold text-white">Refer & Earn Big</h3>
              <p class="text-accent font-bold text-xl mt-1">20% Commission</p>
              <p class="text-xs text-gray-400 mt-2 px-2">Share your link. When friends join and earn, you get 20% of their earnings forever!</p>
          </div>

          <div class="bg-black bg-opacity-50 p-2 rounded-lg flex items-center justify-between mt-6 border border-gray-700">
            <input id="referral-link" class="bg-transparent text-gray-300 text-xs w-full outline-none px-2" readonly value="Loading..." />
            <button id="copy-link-btn" class="bg-accent hover:bg-red-700 text-white px-3 py-1.5 rounded text-xs font-bold">COPY</button>
          </div>
          
          <button id="share-btn" class="w-full mt-4 p-3 rounded-lg btn-accent shadow-md flex items-center justify-center gap-2 font-bold">
              <i data-lucide="share-2" class="w-4 h-4"></i> Share Now
          </button>

          <div class="mt-8 border-t border-gray-700 pt-4">
              <div class="flex justify-between items-center mb-3">
                  <h3 class="text-white text-sm font-bold flex items-center gap-2">
                      <i data-lucide="users" class="w-4 h-4 text-accent"></i> Your Team
                  </h3>
                  <span class="bg-gray-800 border border-gray-600 px-2 py-1 rounded text-[10px] font-bold text-gray-300">
                      Total: <span id="total-refers" class="text-white">0</span>
                  </span>
              </div>
              
              <div id="referral-list" class="space-y-2 max-h-48 overflow-y-auto pr-1 scrollbar-thin">
                  <p class="text-gray-500 text-xs text-center italic py-2">Loading list...</p>
              </div>
          </div>
          </div>
      </div>

      <div id="profile-page" class="p-4 space-y-6 sub-page text-center">
        <div class="flex flex-col items-center mt-4">
          <div class="w-24 h-24 bg-gradient-to-br from-accent to-red-900 rounded-full flex items-center justify-center mb-4 shadow-xl border-4 border-gray-800">
             <i data-lucide="user" class="w-10 h-10 text-white"></i>
          </div>
          <h2 id="profile-name" class="text-2xl font-bold text-white">...</h2>
          <p id="profile-email" class="text-sm text-gray-400">...</p>
        </div>
        
        <div class="card-bg p-5 rounded-xl shadow-lg text-left border border-gray-700">
          <h3 class="font-bold mb-4 text-white text-sm border-b border-gray-700 pb-2">Device Information</h3>
          
          <div class="space-y-3">
              <div>
                  <p class="text-[10px] text-gray-400 uppercase">Device ID</p>
                  <p id="device-id-display" class="text-xs font-mono text-gray-200 truncate">...</p>
              </div>
              <div>
                  <p class="text-[10px] text-gray-400 uppercase">IP Address</p>
                  <p id="ip-address-display" class="text-xs font-mono text-gray-200">Loading...</p>
              </div>
          </div>
        </div>
        
        <button id="logout-btn" class="w-full p-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold shadow-md flex items-center justify-center gap-2">
            <i data-lucide="log-out" class="w-4 h-4"></i> Logout
        </button>
        <p class="text-[10px] text-gray-600 mt-4">Version 1.0.3</p>
      </div>
    </main>

    <nav class="bottom-nav sticky bottom-0 grid grid-cols-5 items-center text-center py-3 card-bg border-t border-gray-700 backdrop-blur-xl z-50">
      <a href="#" class="nav-link active flex flex-col items-center gap-1" data-page="home-page">
          <i data-lucide="home" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Home</span>
      </a>
      <a href="#" class="nav-link flex flex-col items-center gap-1" data-page="earn-page">
          <i data-lucide="play-circle" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Earn</span>
      </a>
      <a href="#" class="nav-link flex flex-col items-center gap-1" data-page="wallet-page">
          <i data-lucide="wallet" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Wallet</span>
      </a>
      <a href="#" class="nav-link flex flex-col items-center gap-1" data-page="refer-page">
          <i data-lucide="users" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Refer</span>
      </a>
      <a href="#" class="nav-link flex flex-col items-center gap-1" data-page="profile-page">
          <i data-lucide="user" class="w-5 h-5"></i>
          <span class="text-[10px] font-medium">Profile</span>
      </a>
    </nav>
  </div>

  <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[100] p-4">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-xs text-center border border-gray-600 shadow-2xl transform transition-all scale-100">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-700 mb-4">
          <i data-lucide="info" class="text-accent w-6 h-6"></i>
      </div>
      <p id="alert-message" class="mb-6 font-medium text-sm text-gray-200">Alert message here</p>
      <button id="alert-ok-btn" class="w-full btn-accent py-2 rounded-lg text-sm font-bold">OK</button>
    </div>
  </div>

  <script type="module">
    // FIREBASE CONFIGURATION (UPDATED)
    const firebaseConfig = {
      apiKey: "AIzaSyBTBOn3xCja4k9A33v1wi-ks0tkxPmqHBQ",
      authDomain: "takakami-70405.firebaseapp.com",
      databaseURL: "https://takakami-70405-default-rtdb.firebaseio.com",
      projectId: "takakami-70405",
      storageBucket: "takakami-70405.firebasestorage.app",
      messagingSenderId: "1062929880210",
      appId: "1:1062929880210:web:60812336c099b9a657024b",
      measurementId: "G-Q66VBXG70X"
    };

    // IMPORTS
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // INITIALIZE FIREBASE
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // STATE VARIABLES
    let currentUser = null;
    let userData = null;
    let appConfig = { minWithdrawal: 5000, dailyAdLimit: 15 };
    let userIP = null;
    let deviceId = null;
    
    // Get Referral Code from URL on load
    let referralCodeFromUrl = new URLSearchParams(window.location.search).get('ref');

    // DOM ELEMENTS
    const loader = document.getElementById('loader');
    const timerModal = document.getElementById('timer-modal');
    const countdownDisplay = document.getElementById('countdown-display');
    const ipWarning = document.getElementById('ip-warning');

    // --- HELPER FUNCTIONS ---

    async function getIPAddress() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        return 'unknown';
      }
    }

    function generateDeviceId() {
      let dId = localStorage.getItem('device_id');
      if (!dId) {
        dId = 'dev_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('device_id', dId);
      }
      return dId;
    }

    // --- SECURITY CHECKS ---

    async function checkDeviceSecurity() {
      const userRef = doc(db, "users", currentUser.uid);
      const userSnap = await getDoc(userRef);
      
      if (userSnap.exists()) {
        const user = userSnap.data();
        // If device is already registered, check it
        if (user.registeredDevice && user.registeredDevice.deviceId) {
          if (user.registeredDevice.deviceId !== deviceId) {
            ipWarning.style.display = 'block';
            showAlert("⚠️ Multiple device detected! Please use your registered device.");
            return false;
          }
        } else {
          // Register this device as the primary one
          await updateDoc(userRef, {
            registeredDevice: {
              deviceId: deviceId,
              ip: userIP,
              registeredAt: serverTimestamp()
            }
          });
        }
      }
      return true;
    }

    async function checkActiveSession() {
      const sessionsRef = collection(db, "active_sessions");
      const q = query(sessionsRef, where("userId", "==", currentUser.uid));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const session = querySnapshot.docs[0].data();
        if (session.deviceId !== deviceId) {
          ipWarning.style.display = 'block';
          showAlert("Another device is already logged in with this account.");
          await signOut(auth);
          return false;
        }
      }
      
      // Update/Create session
      await setDoc(doc(db, "active_sessions", currentUser.uid), {
        userId: currentUser.uid,
        deviceId: deviceId,
        ip: userIP,
        lastActive: serverTimestamp()
      });
      return true;
    }

    async function cleanupSession() {
      if (currentUser) {
        try { await deleteDoc(doc(db, "active_sessions", currentUser.uid)); } catch (e) { console.log(e); }
      }
    }

    // --- INITIALIZATION ---

    window.onload = async () => {
      lucide.createIcons();
      setupEventListeners();
      userIP = await getIPAddress();
      deviceId = generateDeviceId();
      onAuthStateChanged(auth, handleAuthStateChange);
    };

    async function handleAuthStateChange(user) {
      if (user) {
        currentUser = user;
        showLoader(true);
        
        const sessionValid = await checkActiveSession();
        if (!sessionValid) { showLoader(false); return; }
        
        await fetchUserData();
        await fetchAppConfig();
        await checkDeviceSecurity();
        
        updateUI();
        showMainPage('app-container');
        navigateTo('home-page');
        showLoader(false);
      } else {
        await cleanupSession();
        showMainPage('auth-section');
      }
    }

    // --- DATA HANDLING ---

    async function fetchUserData() {
      const userRef = doc(db, "users", currentUser.uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        userData = snap.data();
      } else {
        // Fallback if data missing (should be handled in signup)
        await signOut(auth);
        showAlert("User data error. Please login again.");
      }
    }

    async function fetchAppConfig() {
      try {
        const snap = await getDoc(doc(db, "config", "main"));
        if (snap.exists()) appConfig = snap.data();
      } catch (e) { console.log("Config default used"); }
    }

    // --- UI UPDATES ---

    function updateUI() {
      if (!userData) return;
      
      // Balance
      document.getElementById('coin-balance').textContent = userData.balance;
      document.getElementById('wallet-coin-balance').textContent = userData.balance;
      
      // Profile
      document.getElementById('profile-name').textContent = userData.name;
      document.getElementById('profile-email').textContent = userData.email;
      document.getElementById('device-id-display').textContent = deviceId;
      document.getElementById('ip-address-display').textContent = userIP;
      
      // Referral Link
      const baseUrl = window.location.href.split('?')[0];
      const refLink = `${baseUrl}?ref=${userData.referralCode}`;
      document.getElementById('referral-link').value = refLink;
      
      // Ads Count
      const today = new Date().toISOString().split('T')[0];
      const count = userData.lastAdWatchDate === today ? userData.dailyAdCount : 0;
      const adsLeftEl = document.getElementById('ads-left-count');
      if(adsLeftEl) adsLeftEl.textContent = (appConfig.dailyAdLimit || 15) - count;
    }

    // --- NAVIGATION ---

    window.navigateTo = function(pageId) {
      // Manage Pages
      document.querySelectorAll(".sub-page").forEach(p => p.classList.remove("active"));
      document.getElementById(pageId).classList.add("active");
      
      // Manage Nav Icons
      document.querySelectorAll(".nav-link").forEach(link => {
        link.classList.remove("active", "text-accent");
        if (link.dataset.page === pageId) link.classList.add("active", "text-accent");
      });

      // Page Specific Loads
      if(pageId === 'wallet-page') loadWithdrawalHistory();
      if(pageId === 'refer-page') loadReferralData(); // NEW: Load referral list
    }

    function showMainPage(id) {
      document.querySelectorAll('.main-page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // --- TASKS & EARNING ---

    function startTimerTask(seconds, reward) {
      timerModal.classList.remove('hidden');
      let timeLeft = seconds;
      countdownDisplay.textContent = timeLeft;

      const interval = setInterval(async () => {
        timeLeft--;
        countdownDisplay.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(interval);
          timerModal.classList.add('hidden');
          await addReward(reward);
        }
      }, 1000);
    }

    async function validateTask() {
      if (userData.registeredDevice && userData.registeredDevice.deviceId !== deviceId) {
        showAlert("Please use your registered device.");
        return false;
      }
      const today = new Date().toISOString().split('T')[0];
      const currentCount = userData.lastAdWatchDate === today ? userData.dailyAdCount : 0;
      if (currentCount >= (appConfig.dailyAdLimit || 15)) {
        showAlert("Daily limit reached! Come back tomorrow.");
        return false;
      }
      return true;
    }

    window.visitWebsite = async function(url, seconds) {
      if (!await validateTask()) return;
      window.open(url, '_blank');
      startTimerTask(seconds, 50);
    }

    // --- UPDATED REWARD FUNCTION FOR MONETAG (NEW ID ADDED HERE) ---
    window.claimReward = async (type) => {
      if (!await validateTask()) return;
      
      // Check for the new Monetag function: show_10596279
      if (typeof window.show_10596279 === 'function') {
        showLoader(true);
        try {
          // Calling the new SDK function
          await window.show_10596279();
          await addReward(50);
        } catch (e) {
          console.error(e);
          showAlert("Ad failed to load. Try again.");
        } finally {
          showLoader(false);
        }
      } else {
        showAlert("Ad network initializing... Please wait.");
      }
    };

    async function addReward(reward) {
      // Update activity
      try { await updateDoc(doc(db, "active_sessions", currentUser.uid), { lastActive: serverTimestamp() }); } catch (e) {}
      
      const today = new Date().toISOString().split('T')[0];
      const userRef = doc(db, "users", currentUser.uid);
      
      let newCount = 1;
      if(userData.lastAdWatchDate === today) newCount = (userData.dailyAdCount || 0) + 1;

      const newBalance = (userData.balance || 0) + reward;
      
      await updateDoc(userRef, {
        balance: newBalance,
        dailyAdCount: newCount,
        lastAdWatchDate: today
      });

      // Local update
      userData.balance = newBalance;
      userData.dailyAdCount = newCount;
      userData.lastAdWatchDate = today;
      updateUI();
      showAlert(`Success! You earned ${reward} Coins.`);
    }

    // --- AUTHENTICATION LOGIC ---

    async function handleSignup() {
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const pass = document.getElementById('signup-password').value;
      
      if (!name || !email || !pass) return showAlert("Please fill all fields.");
      if (pass.length < 6) return showAlert("Password must be 6+ chars.");

      showLoader(true);
      try {
        // 1. Check for Referrer if code exists
        let referredByUid = null;
        if (referralCodeFromUrl) {
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("referralCode", "==", referralCodeFromUrl));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                referredByUid = querySnapshot.docs[0].id;
            }
        }

        // 2. Create User
        const res = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(res.user, { displayName: name });
        
        // 3. Save User Data
        const userRef = doc(db, "users", res.user.uid);
        const newReferralCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        
        await setDoc(userRef, {
          uid: res.user.uid,
          name: name,
          email: email,
          balance: 50, // Signup Bonus
          referralCode: newReferralCode,
          referredBy: referredByUid, // Save Referrer ID
          dailyAdCount: 0,
          lastAdWatchDate: new Date().toISOString().split('T')[0],
          registeredDevice: {
            deviceId: deviceId,
            ip: userIP,
            registeredAt: serverTimestamp()
          }
        });

      } catch (e) { 
        if (e.code === 'auth/email-already-in-use') showAlert("Email already registered.");
        else showAlert("Signup failed: " + e.message);
      }
      showLoader(false);
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-password').value;
      
      if(!email || !pass) return showAlert("Enter email and password.");

      showLoader(true);
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch (e) { showAlert("Invalid email or password."); }
      showLoader(false);
    }

    // --- WITHDRAWAL LOGIC ---

    async function handleWithdrawal() {
      if (userData.registeredDevice && userData.registeredDevice.deviceId !== deviceId) {
        return showAlert("Withdrawal restricted to registered device.");
      }
      const amount = parseInt(document.getElementById('withdraw-amount').value);
      const method = document.getElementById('withdraw-method').value;
      const number = document.getElementById('payment-number').value;

      if (!amount || amount < appConfig.minWithdrawal) return showAlert(`Minimum withdrawal: ${appConfig.minWithdrawal} Coins.`);
      if (amount > userData.balance) return showAlert("Insufficient balance.");
      if (!number) return showAlert("Enter payment number.");

      showLoader(true);
      try {
        await addDoc(collection(db, "withdrawals"), {
          userId: currentUser.uid,
          userName: userData.name,
          amount, method, number,
          status: "pending",
          createdAt: serverTimestamp(),
          deviceId: deviceId
        });
        
        const newBalance = userData.balance - amount;
        await updateDoc(doc(db, "users", currentUser.uid), { balance: newBalance });
        
        userData.balance = newBalance;
        updateUI();
        showAlert("Withdrawal request sent!");
        loadWithdrawalHistory();
        document.getElementById('withdraw-amount').value = '';
      } catch (e) { showAlert("Error processing request."); }
      showLoader(false);
    }

    async function loadWithdrawalHistory() {
      const list = document.getElementById('withdrawal-history-list');
      list.innerHTML = '<p class="text-center text-gray-500 text-xs">Loading...</p>';
      
      const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(5));
      const snap = await getDocs(q);
      
      if(snap.empty) {
         list.innerHTML = '<p class="text-center text-gray-500 text-xs">No history found.</p>';
         return;
      }

      list.innerHTML = "";
      snap.forEach(d => {
        const data = d.data();
        let statusColor = 'text-yellow-500';
        if(data.status === 'approved') statusColor = 'text-green-500';
        if(data.status === 'rejected') statusColor = 'text-red-500';
        
        list.innerHTML += `
          <div class="card-bg p-3 rounded-lg flex justify-between items-center text-xs border border-gray-700">
            <div>
                <p class="font-bold text-white">${data.amount} Coins</p>
                <p class="text-gray-400">${data.method} - ${data.number}</p>
            </div>
            <span class="font-bold uppercase ${statusColor} text-[10px] bg-gray-900 px-2 py-1 rounded border border-gray-600">${data.status}</span>
          </div>`;
      });
    }

    // --- REFERRAL LIST LOGIC (NEW) ---

    async function loadReferralData() {
        if (!currentUser) return;
        
        const listContainer = document.getElementById('referral-list');
        const countSpan = document.getElementById('total-refers');
        
        listContainer.innerHTML = '<p class="text-gray-500 text-xs text-center py-2">Loading...</p>';

        try {
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("referredBy", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            
            const totalRefers = querySnapshot.size;
            countSpan.textContent = totalRefers;

            if (totalRefers === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-xs text-center italic py-2">No friends invited yet.</p>';
            } else {
                listContainer.innerHTML = ''; 
                querySnapshot.forEach((doc) => {
                    const friend = doc.data();
                    const friendName = friend.name || "Unknown";
                    // Mask email for privacy
                    const friendEmail = friend.email ? friend.email.substring(0, 3) + "***" + friend.email.slice(friend.email.indexOf('@')) : "****";
                    
                    const itemHtml = `
                        <div class="flex justify-between items-center bg-gray-900 bg-opacity-40 p-2 rounded border border-gray-700 hover:border-accent transition">
                            <div class="flex items-center gap-2">
                                 <div class="w-6 h-6 bg-gray-700 rounded-full flex items-center justify-center text-[10px] text-white font-bold border border-gray-500">
                                    ${friendName.charAt(0).toUpperCase()}
                                 </div>
                                 <div>
                                    <p class="text-xs text-white font-bold">${friendName}</p>
                                    <p class="text-[10px] text-gray-500">${friendEmail}</p>
                                 </div>
                            </div>
                            <span class="text-[10px] text-green-500 font-bold bg-green-900 bg-opacity-20 px-2 py-0.5 rounded">Joined</span>
                        </div>
                    `;
                    listContainer.innerHTML += itemHtml;
                });
            }
        } catch (error) {
            console.error("Referral Error:", error);
            listContainer.innerHTML = '<p class="text-red-400 text-xs text-center">Failed to load data.</p>';
        }
    }

    // --- EVENT LISTENERS ---

    function setupEventListeners() {
      // Auth
      document.getElementById('signup-btn').onclick = handleSignup;
      document.getElementById('login-btn').onclick = handleLogin;
      document.getElementById('logout-btn').onclick = async () => {
        await cleanupSession();
        await signOut(auth);
      };
      
      // Withdraw
      document.getElementById('withdraw-btn').onclick = handleWithdrawal;
      
      // Copy Link
      document.getElementById('copy-link-btn').onclick = () => {
        const link = document.getElementById('referral-link');
        link.select();
        link.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(link.value);
        showAlert("Link Copied!");
      };

      // Share Button
      document.getElementById('share-btn').onclick = async () => {
        const link = document.getElementById('referral-link').value;
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'TAKA KAMAI',
                    text: 'Join Taka Kamai and earn money! Use my link:',
                    url: link
                });
            } catch (err) { console.log(err); }
        } else {
            navigator.clipboard.writeText(link);
            showAlert("Link Copied to Clipboard!");
        }
      };

      // Navigation
      document.querySelectorAll('.nav-link').forEach(l => {
        l.onclick = (e) => { e.preventDefault(); navigateTo(l.dataset.page); };
      });
      
      // Toggle Auth Views
      document.getElementById('show-signup').onclick = () => {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('signup-view').classList.remove('hidden');
      };
      document.getElementById('show-login').onclick = () => {
        document.getElementById('signup-view').classList.add('hidden');
        document.getElementById('login-view').classList.remove('hidden');
      };

      // Alert Close
      document.getElementById('alert-ok-btn').onclick = () => document.getElementById('custom-alert').classList.add('hidden');
    }

    // --- UTILS ---
    function showLoader(s) { loader.classList.toggle('hidden', !s); }
    function showAlert(m) {
      document.getElementById('alert-message').textContent = m;
      document.getElementById('custom-alert').classList.remove('hidden');
    }
  </script>
</body>
</html>
